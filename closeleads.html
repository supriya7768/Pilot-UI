<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <title>Closed Shepherd</title>

    <!-- ========== All CSS files linkup ========= -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="assets/css/lineicons.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="assets/css/materialdesignicons.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/fullcalendar.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
      td {
        color: grey;
        font-size: 12px;
        margin: 10px;
        align-items: center;
      }

      .arrow {
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>
    <!-- ======== Preloader =========== -->

    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img
            style="height: 150px; width: 150px"
            src="./assets/images/SHEPHERD 2.jpg"
          />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="index.html">
              <span class="icon">
                <img class="hi" src="./assets/images/dashboard.png" alt="" />
              </span>
              <span class="text">Dashboard</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="addlead.html">
              <span class="icon">
                <img class="hi" src="./assets/images/user.png" alt="" />
              </span>
              <span class="text">Add Lead</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="leadlist.html">
              <span class="icon">
                <img class="hi" src="./assets/images/group.png" alt="" />
              </span>
              <span class="text">Lead List</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="invoice.html">
              <span class="icon">
                <img class="hi" src="./assets/images/invoice.png" alt="" />
              </span>
              <span class="text">Invoice</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="studentpanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/students.png" alt="" />
              </span>
              <span class="text">Subscribers</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="businesspanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/admin.png" alt="" />
              </span>
              <span class="text">Business Panel</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <!-- ======== sidebar-nav end =========== -->

    <div class="overlay"></div>

    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button
                    id="menu-toggle"
                    class="main-btn primary-btn btn-hover"
                  >
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
                <div class="header-search d-none d-md-flex">
                  <form action="#" id="leadSearchForm">
                    <input
                      type="text"
                      id="leadSearchInput"
                      placeholder="Search Lead Name"
                      style="font-size: 12px; text-align: center"
                    />
                    <button type="button" onclick="searchLeads()">
                      <i class="lni lni-search-alt"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right"></div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title">
                  <h2 style="color: red" class="headings">Closed Leads</h2>
                </div>
              </div>
              <!-- end col -->
            </div>
            <!-- end row -->
          </div>

          <a
            href="leadlist.html"
            class="main-btn primary-btn square-btn btn-hover closebtn headings"
          >
            All Leads
          </a>

          <div class="row">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <h6 class="mb-10">Data Table</h6>
                <div class="table-wrapper table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>
                          <h6>Name</h6>
                        </th>
                        <th>
                          <h6>Mobile No</h6>
                        </th>
                        <th>
                          <h6>Email</h6>
                        </th>
                        <th>
                          <h6>Course</h6>
                        </th>
                        <th>
                          <h6>Status</h6>
                        </th>
                        <!-- <th>
                        <h6>Action</h6>
                      </th> -->
                      </tr>
                      <!-- end table row-->
                    </thead>

                    <tbody id="leadData">
                      <!-- Lead data will be dynamically added here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- ========== section end ========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->

    <!-- ========= All Javascript files linkup ======== -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/Chart.min.js"></script>
    <script src="assets/js/dynamic-pie-chart.js"></script>
    <script src="assets/js/moment.min.js"></script>
    <script src="assets/js/fullcalendar.js"></script>
    <script src="assets/js/jvectormap.min.js"></script>
    <script src="assets/js/world-merc.js"></script>
    <script src="assets/js/polyfill.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/jquery.js"></script>
    <!-- <script src="assets/js/user.js"></script> -->
    <script>
      function fetchLeadData() {
        fetch("http://localhost:8080/get-lead-data")
          .then((response) => response.json())
          .then((data) => {
            const leadData = document.getElementById("leadData");
            // Clear existing data
            leadData.innerHTML = "";

            data
              .filter((lead) => lead.status === "Close")
              .forEach((lead) => {
                const row = document.createElement("tr");
                // Set the lead id as a data attribute
                row.dataset.leadId = lead.id; // Assuming lead has a property called 'id'

                row.innerHTML += `
              <td><a href="leadInfo.html?leadId=${lead.id}">${
                  lead.name
                }</a></td>
              <td>${lead.mobile}</td>
              <td>${lead.email}</td>
              <td>${lead.courseIntrested}</td>
              <td>${lead.status}</td>
              <td>
                  <div class="action"  style="display: none;">
                      ${
                        lead.status === "Open" ||
                        lead.status === "Contacted" ||
                        lead.status === "Proposal Sent"
                          ? `
                          <select onchange="changeStatus(this)">
                            <option value="">Edit</option>
                            <option value="Open">Open</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Proposal Sent">Proposal Sent</option> 
                            <option value="Deal Done">Deal Done</option>
                            <option value="Close">Close</option>
                          </select>
                      `
                          : lead.status === "Deal Done"
                          ? `
                          <a href="invoice.html?leadName=${lead.name}&leadEmail=${lead.email}" class="create-invoice-link">
                              Invoice
                          </a>
                      `
                          : lead.status === "Close"
                          ? `
                          <a style="color: red;">Delete</a>
                      `
                          : ""
                      }
                  </div>
              </td>
              <td>
                <div class="action">
                  <!-- Edit option -->
                  <a href="#" onclick="editLead(event, ${lead.id})">Edit</a>
                </div>
              </td>
          `;

                leadData.appendChild(row);
              });
          })
          .catch((error) => {
            console.error("Error fetching data: " + error);
          });
      }
    </script>

    <script>
      // Function to handle editing a lead
      function editLead(event, leadId) {
        event.preventDefault();
        const existingEditSections = document.querySelectorAll(".edit-section");
        existingEditSections.forEach((section) => section.remove());

        const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);

        // Create and append the edit section
        const editSection = document.createElement("tr");
        editSection.classList.add("edit-section");
        editSection.innerHTML = `
              <td colspan="6">
                <!-- Your edit form or content goes here -->
                <label for="newFollowUpDate">New Date</label>
                <input type="date" id="newFollowUpDate" placeholder="DD/MM/YYYY" style="text-transform: uppercase; vertical-align: middle; margin-left: 5px; font-size:10px;">
                <label style="margin-left:10px" for="newComment">New Comment:</label>
                <textarea id="newComment" rows="1" style="vertical-align: middle; margin-left: 5px;" placeholder="Add new comment"></textarea>
          
                <!-- Add a new select element for changing status -->
                <label style="margin-left:10px" for="changeStatus">Change Status:</label>
                <select id="changeStatus" style="color: black;">
                  <option value="">Select</option>
                  <option value="Open">Open</option>
                  <option value="Contacted">Contacted</option>
                  <option value="Proposal Sent">Proposal Sent</option> 
                  <option value="Deal Done">Deal Done</option>
                  <option value="Close">Close</option>
                </select>

                <button class="main-btn primary-btn btn-hover" style="height: 5px; width: 5px; vertical-align: middle; margin-left: 5px; font-size:14px;" onclick="saveEdits(${leadId})">Save</button>
              
                <!-- Action part (initially hidden) -->
                <div class="action" style="display: block;">
                  <!-- Include your action content here -->
                  <!-- Add a placeholder for the select element -->
                  <select style="display: none;"></select>
                  <button class="main-btn primary-btn btn-hover" style="font-size: 14px; margin-left: 5px;" onclick="changeAction(${leadId})">Action Change</button>
                </div>
              </td>
              `;

        row.insertAdjacentElement("afterend", editSection);

        // Hide the action part in the row
        const actionSection = row.querySelector(".action");
        actionSection.style.display = "none";
      }

      function saveEdits(leadId) {
        const newFollowUpDateInput = document.getElementById("newFollowUpDate");
        const newCommentInput = document.getElementById("newComment");
        const changeStatusInput = document.getElementById("changeStatus");

        const newFollowUpDate = newFollowUpDateInput.value;
        const newComment = newCommentInput.value;
        const changeStatus = changeStatusInput.value;

        // Validate that all three fields are filled
        if (!newFollowUpDate || !newComment || !changeStatus) {
          alert("Please fill in all required fields.");
          return;
        }

        // Fetch API to send data to the server
        const url = `http://localhost:8080/save-edits/${leadId}`;
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `newFollowUpDate=${newFollowUpDate}&newComment=${newComment}&changeStatus=${changeStatus}`,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Error saving edits");
            }
            return response.text();
          })
          .then((data) => {
            console.log(data); // Log the response from the server
            // Remove the edit section after saving
            const editSection = document.querySelector(".edit-section");
            editSection.remove();

            // Update the calendar and table entry simultaneously
            const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);
            const followDateCell = row.querySelector("td:nth-child(4)");
            followDateCell.textContent = newFollowUpDate;

            const commentCell = row.querySelector("td:nth-child(3)");
            commentCell.textContent = newComment;

            // Remove the row from the table
            row.remove();

            // Update the calendar with the removed lead's date
            updateCalendarAfterRemove(removedLeadDate);
          })
          .catch((error) => {
            console.error("Error:", error);
            // Handle the error, show an alert, or perform other actions
          });
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchLeadData();
        document.addEventListener("change", function (event) {
          if (event.target.tagName === "SELECT") {
            changeStatus(event.target);
          }
        });
      });
    </script>
    <script>
      function getButtonClass(status) {
        switch (status) {
          case "Open":
            return "newbtnopen";
          case "Contacted":
            return "newbtncontacted";
          case "Proposal Sent":
            return "newbtnproposalsent";
          case "Deal Done":
            return "newbtndealdone";
          case "Close":
            return "newbtnclose";

          default:
            return "default-btn"; // You can define a default class for other statuses
        }
      }

      function showConfirmationDialog(selectedStatus, row) {
        const currentStatus = row.querySelector("td:nth-child(5)").textContent;
        return confirm(
          `Do you want to change status from ${currentStatus} to ${selectedStatus}?`
        );
      }

      function changeStatus(selectElement) {
        const selectedStatus = selectElement.value;
        const row = selectElement.closest("tr");
        const leadId = row.dataset.leadId;

        if (!showConfirmationDialog(selectedStatus, row)) {
          // User clicked Cancel in the confirmation dialog
          selectElement.value =
            row.querySelector("td:nth-child(5)").textContent;
          return;
        }

        fetch(`http://localhost:8080/update-lead/${leadId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: selectedStatus }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((updatedStatus) => {
            const statusCell = row.querySelector("td:nth-child(5)");
            const actionCell = row.querySelector("td:nth-child(6)");

            statusCell.textContent = updatedStatus;
            statusCell.className = getButtonClass(updatedStatus);
            actionCell.innerHTML = getActionHTML(
              updatedStatus,
              row.cells[0].textContent,
              row.cells[2].textContent
            );

            if (updatedStatus === "Done") {
              if (confirm("Do you want to change status as Done?")) {
                statusCell.textContent = updatedStatus;
                statusCell.className = getButtonClass(updatedStatus);
                actionCell.innerHTML = getActionHTML(
                  updatedStatus,
                  row.cells[0].textContent,
                  row.cells[2].textContent
                );
              } else {
                // Revert to the previous status
                selectElement.value = statusCell.textContent;
              }
            } else {
              statusCell.textContent = updatedStatus;
              statusCell.className = getButtonClass(updatedStatus);
              actionCell.innerHTML = getActionHTML(updatedStatus);
            }

            // Reload the page after updating the status
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error updating status: " + error);
          });
      }

      function getActionHTML(status, name, email) {
        if (status === "Deal Done") {
          return `
            <a href="invoice.html?leadName=${name}&leadEmail=${email}" class="create-invoice-link">
                Invoice
            </a>
        `;
        } else if (status === "Close") {
          return `
            <a style="color: red;">Delete</a>
        `;
        } else if (status === "Open") {
          return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Open" ? "selected" : ""
                }>Edit</option>
                <option value="Contacted" ${
                  status === "Contacted" ? "selected" : ""
                }>Contacted</option>
                <option value="Proposal Sent" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Proposal Sent</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
        } else if (status === "Contacted") {
          return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Contacted" ? "selected" : ""
                }>Edit</option>
                <option value="Open" ${
                  status === "Open" ? "selected" : ""
                }>Open</option>
                <option value="Proposal Sent" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Proposal Sent</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
        } else if (status === "Proposal Sent") {
          return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Edit</option>
                <option value="Open" ${
                  status === "Open" ? "selected" : ""
                }>Open</option>
                <option value="Contacted" ${
                  status === "Contacted" ? "selected" : ""
                }>Contacted</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
        } else {
          return "";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchLeadData();
        document.addEventListener("change", function (event) {
          if (event.target.tagName === "SELECT") {
            changeStatus(event.target);
          }
        });
      });
    </script>
    <script>
      function searchLeads() {
        var searchTerm = document
          .getElementById("leadSearchInput")
          .value.toLowerCase();
        var leadRows = document.querySelectorAll("#leadData tr");

        leadRows.forEach(function (leadRow) {
          var leadNameText = leadRow
            .querySelector("td:nth-child(1)")
            .textContent.toLowerCase();

          if (leadNameText.includes(searchTerm)) {
            leadRow.style.display = "table-row";
          } else {
            leadRow.style.display = "none";
          }
        });
      }

      // Add an event listener for the "input" event on the search input field
      document
        .getElementById("leadSearchInput")
        .addEventListener("input", function () {
          // Call the searchLeads function whenever the user types or deletes characters
          searchLeads();
        });
    </script>
  </body>
</html>
