<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <title>Shepherd</title>
    <!-- ========== All CSS files linkup ========= -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="assets/css/lineicons.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="assets/css/materialdesignicons.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/fullcalendar.css" />
    <!-- <link rel="stylesheet" href="assets/css/fullcalendar.css" /> -->
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
      .event-bubble {
        cursor: pointer;
      }
    </style>
    <style>
      .flex-containerc {
        display: flex;
        justify-content: space-between;
      }

      .col-lg-5c {
        flex: 0 0 auto; /* Do not grow or shrink */
        width: 49%; /* Adjust the width as needed */
      }

      .col-xl-6c {
        flex: 0 0 auto; /* Do not grow or shrink */
        width: 50%; /* Adjust the width as needed */
      }
      .col-xl-6c {
        width: 50%; /* Adjust the width as needed */
      }

      .card-style-5c {
        padding: 20px;
        text-align: center;
      }
      #dynamicNumbers {
        transition: transform 0.5s ease-in-out;
      }
      .dnum {
        font-weight: 800;
        font-size: x-large;
        color: #4064f6;
      }

      /* Add any additional styling as needed */
    </style>
    <!-- <style type="text/css">
      #container {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style> -->
  </head>

  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>
    <!-- ======== Preloader =========== -->
    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img
            style="height: 150px; width: 150px"
            src="./assets/images/SHEPHERD 2.jpg"
          />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="index.html">
              <span class="icon">
                <img class="hi" src="./assets/images/dashboard.png" alt="" />
              </span>
              <span class="text">Dashboard</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="addlead.html">
              <span class="icon">
                <img class="hi" src="./assets/images/user.png" alt="" />
              </span>
              <span class="text">Add Lead</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="leadlist.html">
              <span class="icon">
                <img class="hi" src="./assets/images/group.png" alt="" />
              </span>
              <span class="text">Lead List</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="invoice.html">
              <span class="icon">
                <img class="hi" src="./assets/images/invoice.png" alt="" />
              </span>
              <span class="text">Invoice</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="studentpanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/students.png" alt="" />
              </span>
              <span class="text">Subscribers</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="businesspanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/admin.png" alt="" />
              </span>
              <span class="text">Business Panel</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <!-- ======== sidebar-nav end =========== -->
    <div class="overlay"></div>
    <!-- ======== sidebar-nav end =========== -->
    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button
                    id="menu-toggle"
                    class="main-btn primary-btn btn-hover"
                  >
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right">
                <!-- profile start -->
                <div class="profile-box ml-15">
                  <button
                    class="dropdown-toggle bg-transparent border-0"
                    type="button"
                    id="profile"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <div class="profile-info">
                      <div class="info">
                        <div class="image">
                          <img src="assets/images/logo.png" alt="" />
                        </div>
                        <div>
                          <h6 class="fw-500">Testing Shastra</h6>
                          <p>Admin</p>
                        </div>
                      </div>
                    </div>
                  </button>
                  <ul
                    class="dropdown-menu dropdown-menu-end"
                    aria-labelledby="profile"
                  >
                    <li>
                      <div class="author-info flex items-center !p-1">
                        <div class="image">
                          <img
                            src="assets/images/profile/profile-image.png"
                            alt="image"
                          />
                        </div>
                        <div class="content">
                          <h4 class="text-sm">Adam Joe</h4>
                          <!-- <a class="text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white text-xs" href="#">Email@gmail.com</a> -->
                        </div>
                      </div>
                    </li>
                    <li class="divider"></li>
                    <li>
                      <a href="#0">
                        <i class="lni lni-user"></i> View Profile
                      </a>
                    </li>
                    <li>
                      <a href="#0">
                        <i class="lni lni-alarm"></i> Notifications
                      </a>
                    </li>
                    <li>
                      <a href="#0"> <i class="lni lni-inbox"></i> Messages </a>
                    </li>
                    <li>
                      <a href="#0"> <i class="lni lni-cog"></i> Settings </a>
                    </li>
                    <li class="divider"></li>
                    <li>
                      <a href="#0"> <i class="lni lni-exit"></i> Sign Out </a>
                    </li>
                  </ul>
                </div>
                <!-- profile end -->
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->
      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title">
                  <h5>Hello, Testing Shastra</h5>
                </div>
              </div>
            </div>

            <div class="flex-containerc">
              <div class="col-lg-5c text-xs">
                <div class="card-style calendar-card mb-20">
                  <div id="calendar-mini" class="calendar2"></div>
                </div>
              </div>

              <div class="col-xl-6c">
                <div class="card-style-5 mb-30">
                  <!-- <div class="card-image"> -->
                  <div
                    id="dynamicNumbers"
                    style="
                      display: flex;
                      margin-left: 20px;
                      margin-right: 20px;
                      font-family: Nunito, sans-serif;
                    "
                  >
                    <!-- Placeholder for dynamic numbers -->
                    <div id="label1" class="ml-50">
                      All Leads
                      <br />
                      <span class="mt-1 dnum" id="number1">0</span>
                    </div>

                    <div id="label2" class="ml-50">
                      Deal Done <br />
                      <span class="fit-content mt-1 dnum" id="number2">0</span>
                    </div>

                    <div id="label3" class="ml-50">
                      Closed
                      <br />
                      <span class="fit-content mt-1 dnum" id="number3">0</span>
                    </div>
                  </div>
                  <!-- </div> -->
                </div>
                <!-- End Row -->
                <!-- <div class="row"> -->
                <div class="col-lg-7" style="width: 100%">
                  <div class="card-style mb-10">
                    <div
                      class="title d-flex flex-wrap align-items-center justify-content-between"
                    >
                      <div class="left">
                        <h6 class="text-medium mb-2">Sales Forecast</h6>
                      </div>
                      <div class="right">
                        <div class="select-style-1 mb-2">
                          <div class="select-position select-sm"></div>
                        </div>
                        <!-- end select -->
                      </div>
                    </div>
                    <!-- End Title -->
                    <div class="chart">
                      <div id="container"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Col -->
            <div class="col-lg-7 w-100 text-xs">
              <div class="card-style mb-30">
                <div
                  class="title d-flex flex-wrap align-items-center justify-content-between"
                >
                  <div class="left">
                    <h6 class="text-small mb-30">Follow Up</h6>
                  </div>
                  <div class="right">
                    <div class="select-style-1">
                      <!-- <h4>Check leads on</h4> -->
                      <input type="date" id="followDateInput" />
                    </div>
                    <!-- end select -->
                  </div>
                </div>
                <!-- End Title -->
                <div class="table-responsive">
                  <table class="table top-selling-table">
                    <thead>
                      <tr>
                        <th>
                          <h6>Name</h6>
                        </th>
                        <th>
                          <h6>Mobile No</h6>
                        </th>
                        <th>
                          <h6>Recent Comment</h6>
                        </th>
                        <th>
                          <h6>Follow On</h6>
                        </th>
                        <th>
                          <h6>Status</h6>
                        </th>
                        <!-- <th>
                          <h6>Action</h6>
                        </th> -->
                      </tr>
                      <!-- end table row-->
                    </thead>

                    <tbody id="leadTable">
                      <!--Adding Leads Dynamically-->
                    </tbody>
                  </table>
                  <!-- End Table -->
                </div>
              </div>
            </div>
            <!-- End Col -->
          </div>
          <!-- End Row -->
        </div>
        <!-- end container -->
        <!-- </section> -->
        <!-- ========== section end ========== -->

        <!-- </main> -->
        <!-- ======== main-wrapper end =========== -->

        <!-- ========= All Javascript files linkup ======== -->
        <script src="assets/js/bootstrap.bundle.min.js"></script>
        <script src="assets/js/Chart.min.js"></script>
        <script src="assets/js/dynamic-pie-chart.js"></script>
        <script src="assets/js/moment.min.js"></script>
        <script src="assets/js/fullcalendar.js"></script>
        <script src="assets/js/jvectormap.min.js"></script>
        <script src="assets/js/world-merc.js"></script>
        <script src="assets/js/polyfill.js"></script>
        <script src="assets/js/main.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="./assets/js/newcalender.js"></script>
        <!-- <script src="./assets/js/user.js"></script> -->
        <script src="./assets/js/jquery.js"></script>
        <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-base.min.js"></script>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            var calendarMiniEl = document.getElementById("calendar-mini");
            var calendarMini = new FullCalendar.Calendar(calendarMiniEl, {
              initialView: "dayGridMonth",
              headerToolbar: {
                end: "today prev,next",
              },
            });
            calendarMini.render();
          });
        </script>

        <script>
          function fetchLeadsByDate(selectedDate) {
            fetch("http://localhost:8080/get-lead-data-dashboard")
              .then((response) => response.json())
              .then((data) => {
                const leadData = document.getElementById("leadTable");
                leadData.innerHTML = ""; // Clear existing data

                data
                  .filter(
                    (lead) =>
                      lead.status === "Open" ||
                      lead.status === "Contacted" ||
                      lead.status === "Proposal Sent"
                  )
                  .forEach((lead) => {
                    const followDate = lead.follow.split("T")[0]; // Assuming the follow date is in 'YYYY-MM-DD' format

                    if (followDate === selectedDate) {
                      const row = document.createElement("tr");
                      row.dataset.leadId = lead.id;
                      row.innerHTML = `
                        <td><a href="leadInfo.html?leadId=${lead.id}">${lead.name}</a></td>
                        <td>${lead.mobile}</td>
                        <td>${lead.comment}</td>
                        <td>${lead.follow}</td>
                        <td>${lead.status}</td>
                        
              <td>
                <div class="action">
                  <!-- Edit option -->
                  <a href="#" onclick="editLead(event, ${lead.id})">Edit</a>
                </div>
              </td>
            `;
                      leadData.appendChild(row);
                    }
                  });
              })
              .catch((error) => {
                console.error("Error fetching data: " + error);
              });
          }

          function renderNumbersOnDates(datesWithNumbers) {
            Object.keys(datesWithNumbers).forEach(function (date) {
              const bubbleNumber = datesWithNumbers[date];
              if (bubbleNumber > 0) {
                const dateCell = $(`#calendar-mini [data-date="${date}"]`);
                const bubble = $('<div class="event-bubble"></div>').text(
                  bubbleNumber
                );

                // Add an event listener to the bubble
                bubble.click(function () {
                  const clickedDate = $(this).parent().data("date"); // Retrieve the date from the parent element
                  fetchLeadsByDate(clickedDate);
                });

                dateCell.append(bubble);
              }
            });
          }

          //=========================Count of Follow on the calender=================================================

          $(document).ready(function () {
            // Function to fetch lead counts for all dates
            function fetchLeadCountsForAllDates() {
              fetch("http://localhost:8080/get-all-lead-counts")
                .then((response) => response.json())
                .then((data) => {
                  // Assuming data is an object with the date as the key and lead count as the value
                  renderNumbersOnDates(data);
                  displayTotalLeadCount(data);
                })
                .catch((error) => {
                  console.error("Error fetching lead counts: " + error);
                });
            }

            function displayTotalLeadCount(datesWithNumbers) {
              const totalLeadCount = Object.values(datesWithNumbers).reduce(
                (acc, count) => acc + count,
                0
              );
              $("#totalCountElement").text(`Total Leads: ${totalLeadCount}`);
            }

            fetchLeadCountsForAllDates();
          });

          // Function to handle editing a lead
          function editLead(event, leadId) {
            event.preventDefault();
            const existingEditSections =
              document.querySelectorAll(".edit-section");
            existingEditSections.forEach((section) => section.remove());

            const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);

            // Create and append the edit section
            const editSection = document.createElement("tr");
            editSection.classList.add("edit-section");
            editSection.innerHTML = `
              <td colspan="6">
                <!-- Your edit form or content goes here -->
                <label for="newFollowUpDate">New Date</label>
                <input type="date" id="newFollowUpDate" placeholder="DD/MM/YYYY" style="text-transform: uppercase; vertical-align: middle; margin-left: 5px; font-size:10px;">
                <label style="margin-left:10px" for="newComment">New Comment:</label>
                <textarea id="newComment" rows="1" style="vertical-align: middle; margin-left: 5px;" placeholder="Add new comment"></textarea>
          
                <!-- Add a new select element for changing status -->
                <label style="margin-left:10px" for="changeStatus">Change Status:</label>
                <select id="changeStatus" style="color: black;">
                  <option value="">Select</option>
                  <option value="Open">Open</option>
                  <option value="Contacted">Contacted</option>
                  <option value="Proposal Sent">Proposal Sent</option> 
                  <option value="Deal Done">Deal Done</option>
                  <option value="Close">Close</option>
                </select>

                <button class="main-btn primary-btn btn-hover" style="height: 5px; width: 5px; vertical-align: middle; margin-left: 5px; font-size:14px;" onclick="saveEdits(${leadId})">Save</button>
                <!-- Action part (initially hidden) -->
                <div class="action" style="display: block;">
                  <!-- Include your action content here -->
                  <!-- Add a placeholder for the select element -->
                  <select style="display: none;"></select>
                  <button class="main-btn primary-btn btn-hover" style="font-size: 14px; margin-left: 5px;" onclick="changeAction(${leadId})">Action Change</button>
                </div>
              </td>
              `;

            row.insertAdjacentElement("afterend", editSection);

            // Hide the action part in the row
            const actionSection = row.querySelector(".action");
            actionSection.style.display = "none";
          }

          function saveEdits(leadId) {
            const newFollowUpDateInput =
              document.getElementById("newFollowUpDate");
            const newCommentInput = document.getElementById("newComment");
            const changeStatusInput = document.getElementById("changeStatus");

            const newFollowUpDate = newFollowUpDateInput.value;
            const newComment = newCommentInput.value;
            const changeStatus = changeStatusInput.value;

            // Validate that all three fields are filled
            if (!newFollowUpDate || !newComment || !changeStatus) {
              alert("Please fill in all required fields.");
              return;
            }

            // Fetch API to send data to the server
            const url = `http://localhost:8080/save-edits/${leadId}`;
            fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: `newFollowUpDate=${newFollowUpDate}&newComment=${newComment}&changeStatus=${changeStatus}`,
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Error saving edits");
                }
                return response.text();
              })
              .then((data) => {
                console.log(data); // Log the response from the server
                // Remove the edit section after saving
                const editSection = document.querySelector(".edit-section");
                editSection.remove();

                // Update the calendar and table entry simultaneously
                const row = document.querySelector(
                  `tr[data-lead-id="${leadId}"]`
                );
                const followDateCell = row.querySelector("td:nth-child(4)");
                followDateCell.textContent = newFollowUpDate;

                const commentCell = row.querySelector("td:nth-child(3)");
                commentCell.textContent = newComment;

                // Remove the row from the table
                row.remove();

                // Update the calendar with the removed lead's date
                updateCalendarAfterRemove(removedLeadDate);
              })
              .catch((error) => {
                console.error("Error:", error);
                // Handle the error, show an alert, or perform other actions
              });
          }

          function getButtonClass(status) {
            switch (status) {
              case "Open":
                return "newbtnopen";
              case "Contacted":
                return "newbtncontacted";
              case "Proposal Sent":
                return "newbtnproposalsent";
              case "Deal Done":
                return "newbtndealdone";
              case "Close":
                return "newbtnclose";

              default:
                return "default-btn"; // You can define a default class for other statuses
            }
          }

          function showConfirmationDialog(selectedStatus, row) {
            const currentStatus =
              row.querySelector("td:nth-child(5)").textContent;
            return confirm(
              `Do you want to change status from ${currentStatus} to ${selectedStatus}?`
            );
          }

          function changeStatus(selectElement) {
            const selectedStatus = selectElement.value;
            const row = selectElement.closest("tr");
            const leadId = row.dataset.leadId;
            const comment = row.querySelector("td:nth-child(3)").textContent; // Assuming the comment is in the third column

            // Check if a comment exists before allowing status change
            if (!comment.trim()) {
              alert(
                "Please add a compulsory comment before changing the status."
              );
              selectElement.value =
                row.querySelector("td:nth-child(5)").textContent; // Reset the select element
              return;
            }

            if (!showConfirmationDialog(selectedStatus, row)) {
              // User clicked Cancel in the confirmation dialog
              selectElement.value =
                row.querySelector("td:nth-child(5)").textContent;
              return;
            }

            const followDateCell = row.querySelector("td:nth-child(4)");

            if (selectedStatus === "Deal Done" || selectedStatus === "Close") {
              // Update the follow date to empty when the status is "Deal Done" or "Close"
              const removedLeadDate = followDateCell.textContent;
              followDateCell.textContent = "";

              // Remove the row from the table
              row.remove();

              // Update the calendar with the removed lead's date
              updateCalendarAfterRemove(removedLeadDate);
            }

            fetch(`http://localhost:8080/update-lead/${leadId}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: selectedStatus }),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((updatedStatus) => {
                const statusCell = row.querySelector("td:nth-child(5)");
                const actionCell = row.querySelector("td:nth-child(6)");

                statusCell.textContent = selectedStatus;
                statusCell.className = getButtonClass(selectedStatus);
                actionCell.innerHTML = getActionHTML(
                  selectedStatus,
                  row.cells[0].textContent,
                  row.cells[2].textContent
                );
              })
              .catch((error) => {
                console.error("Error updating status: " + error);
              });
          }

          function updateCalendarAfterRemove(removedLeadId) {
            // Fetch the updated lead data and update the calendar
            fetch("http://localhost:8080/get-lead-data-dashboard")
              .then((response) => response.json())
              .then((data) => {
                const filteredLeads = data.filter(
                  (lead) =>
                    lead.id !== removedLeadId &&
                    lead.status !== "Deal Done" &&
                    lead.status !== "Closed"
                );

                // Update the calendar with the filtered leads
                updateCalendar(filteredLeads);
              })
              .catch((error) => {
                console.error("Error fetching data: " + error);
              });
          }

          function getUpdatedCalendarEntries(removedLeadDate) {
            const calendarEntries = { ...calendarEntries };
            if (calendarEntries.hasOwnProperty(removedLeadDate)) {
              calendarEntries[removedLeadDate] -= 1;
            }
            return calendarEntries;
          }

          function getActionHTML(status, name, email, mobile) {
            if (status === "Deal Done") {
              return `
            <a href="invoice.html?leadName=${name}&leadEmail=${email}&leadMobile=${mobile}" class="create-invoice-link">
                Invoice
            </a>
        `;
            } else if (status === "Close") {
              return `
            <a style="color: red;">Delete</a>
        `;
            } else if (status === "Open") {
              return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Open" ? "selected" : ""
                }>Edit</option>
                <option value="Contacted" ${
                  status === "Contacted" ? "selected" : ""
                }>Contacted</option>
                <option value="Proposal Sent" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Proposal Sent</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
            } else if (status === "Contacted") {
              return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Contacted" ? "selected" : ""
                }>Edit</option>
                <option value="Open" ${
                  status === "Open" ? "selected" : ""
                }>Open</option>
                <option value="Proposal Sent" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Proposal Sent</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
            } else if (status === "Proposal Sent") {
              return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Proposal Sent" ? "selected" : ""
                }>Edit</option>
                <option value="Open" ${
                  status === "Open" ? "selected" : ""
                }>Open</option>
                <option value="Contacted" ${
                  status === "Contacted" ? "selected" : ""
                }>Contacted</option>
                <option value="Deal Done" ${
                  status === "Deal Done" ? "selected" : ""
                }>Deal Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
            } else {
              return "";
            }
          }

          const dateInput = document.getElementById("followDateInput");
          dateInput.addEventListener("change", function () {
            let selectedDate = dateInput.value; // Get the selected date from the input

            // If no date is selected, default to the current date
            if (!selectedDate) {
              const currentDate = new Date();
              const year = currentDate.getFullYear();
              const month = String(currentDate.getMonth() + 1).padStart(2, "0");
              const day = String(currentDate.getDate()).padStart(2, "0");
              selectedDate = `${year}-${month}-${day}`;
              dateInput.value = selectedDate; // Set the input value to the default date
            }

            fetchLeadsByDate(selectedDate);
          });

          // Trigger the change event to fetch data for the default date on page load
          dateInput.dispatchEvent(new Event("change"));

          // Modify the renderNumbersOnDates function to handle the addition of bubbles dynamically
          function renderNumbersOnDates(datesWithNumbers) {
            Object.keys(datesWithNumbers).forEach(function (date) {
              const bubbleNumber = datesWithNumbers[date];
              if (bubbleNumber > 0) {
                const dateCell = $(`#calendar-mini [data-date="${date}"]`);
                const bubble = $('<div class="event-bubble"></div>').text(
                  bubbleNumber
                );

                // Add an event listener to the bubble
                bubble.click(function () {
                  dateInput.value = date; // Set the input value to the clicked date
                  dateInput.dispatchEvent(new Event("change")); // Trigger change event to fetch leads
                });

                dateCell.append(bubble);
              }
            });
          }
        </script>

        <script>
          // Function to update numbers dynamically
          function updateNumbers() {
            // Initialize numbers
            let number1 = 0;
            let number2 = 0;
            let number3 = 0;

            // Make a GET request to fetch total lead counts
            fetch("http://localhost:8080/get-total-lead-counts")
              .then((response) => response.json())
              .then((data) => {
                // Check if the response has the expected structure
                if (data !== undefined) {
                  // Calculate the increment based on the total count
                  const increment1 = Math.ceil(data / 3);

                  // Function to increment numbers gradually for number1
                  function incrementNumber1() {
                    number1 = Math.min(number1 + increment1, data);
                    document.getElementById("number1").textContent = number1;

                    // Check if the final number is reached for number1
                    if (number1 >= data) {
                      clearInterval(incrementInterval1);
                    }
                  }

                  // Call the function to increment number1 at a certain interval
                  const incrementInterval1 = setInterval(incrementNumber1, 500);

                  // Make a GET request to fetch total lead counts for "Deal Done"
                  fetch("http://localhost:8080/get-total-lead-counts-done")
                    .then((response) => response.json())
                    .then((dataDone) => {
                      // Update number2 with the count for "Deal Done"
                      number2 = Math.min(dataDone, data);
                      document.getElementById("number2").textContent = number2;

                      // Check if the final number is reached for number2
                      if (number2 >= data) {
                        clearInterval(incrementInterval2);
                      }
                    })
                    .catch((error) => {
                      console.error(
                        "Error fetching total lead counts for Deal Done:",
                        error
                      );
                    });

                  // Make a GET request to fetch total lead counts for "Close"
                  fetch("http://localhost:8080/get-total-lead-counts-close")
                    .then((response) => response.json())
                    .then((dataClose) => {
                      // Update number3 with the count for "Close"
                      number3 = Math.min(dataClose, data);
                      document.getElementById("number3").textContent = number3;

                      // Check if the final number is reached for number3
                      if (number3 >= data) {
                        clearInterval(incrementInterval3);
                      }
                    })
                    .catch((error) => {
                      console.error(
                        "Error fetching total lead counts for Close:",
                        error
                      );
                    });
                }
              })
              .catch((error) => {
                console.error("Error fetching total lead counts:", error);
              });
          }

          // Call the function to start updating numbers
          updateNumbers();
        </script>

        <script>
          anychart.onDocumentReady(function () {
            // add data
            var data = [
              ["2003", 1, 0, 0],
              ["2004", 4, 0, 0],
              ["2005", 6, 0, 0],
              ["2006", 9, 1, 0],
              ["2007", 12, 2, 0],
              ["2008", 13, 5, 1],
              ["2009", 15, 6, 1],
              ["2010", 16, 9, 1],
              ["2011", 16, 10, 4],
              ["2012", 17, 11, 5],
              ["2013", 17, 13, 6],
              ["2014", 17, 14, 7],
              ["2015", 17, 14, 10],
              ["2016", 17, 14, 12],
              ["2017", 19, 16, 12],
              ["2018", 20, 17, 14],
              ["2019", 20, 19, 16],
              ["2020", 20, 20, 17],
              ["2021", 20, 20, 20],
              ["2022", 20, 22, 20],
            ];

            // create a data set
            var dataSet = anychart.data.set(data);

            // map the data for all series
            var firstSeriesData = dataSet.mapAs({ x: 0, value: 1 });
            var secondSeriesData = dataSet.mapAs({ x: 0, value: 2 });
            var thirdSeriesData = dataSet.mapAs({ x: 0, value: 3 });

            // create a line chart
            var chart = anychart.line();

            // create the series and name them
            var firstSeries = chart.line(firstSeriesData);
            firstSeries.name("Roger Federer");
            var secondSeries = chart.line(secondSeriesData);
            secondSeries.name("Rafael Nadal");
            var thirdSeries = chart.line(thirdSeriesData);
            thirdSeries.name("Novak Djokovic");

            // // add a legend
            // chart.legend().enabled(true);

            // // add a title
            // chart.title("Big Three's Grand Slam Title Race");

            // specify where to display the chart
            chart.container("container");

            // draw the resulting chart
            chart.draw();
          });
        </script>
      </section>
    </main>
  </body>
</html>
