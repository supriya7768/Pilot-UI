<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <title>Shepherd</title>

    <!-- ========== All CSS files linkup ========= -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="assets/css/lineicons.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="assets/css/materialdesignicons.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/fullcalendar.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
      td {
        color: grey;
        font-size: 12px;
        margin: 10px;
        align-items: center;
      }
    </style>
  </head>

  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>
    <!-- ======== Preloader =========== -->

    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img
            style="height: 150px; width: 150px"
            src="./assets/images/SHEPHERD 2.jpg"
          />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="index.html">
              <span class="icon">
                <img class="hi" src="./assets/images/dashboard.png" alt="" />
              </span>
              <span class="text">Dashboard</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="addlead.html">
              <span class="icon">
                <img class="hi" src="./assets/images/user.png" alt="" />
              </span>
              <span class="text">Add Lead</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="leadlist.html">
              <span class="icon">
                <img class="hi" src="./assets/images/group.png" alt="" />
              </span>
              <span class="text">Lead List</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="invoice.html">
              <span class="icon">
                <img class="hi" src="./assets/images/invoice.png" alt="" />
              </span>
              <span class="text">Invoice</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="studentpanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/students.png" alt="" />
              </span>
              <span class="text">Student Panel</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="adminpanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/admin.png" alt="" />
              </span>
              <span class="text">Admin Panel</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <!-- ======== sidebar-nav end =========== -->

    <div class="overlay"></div>

    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button
                    id="menu-toggle"
                    class="main-btn primary-btn btn-hover"
                  >
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
                <div class="header-search d-none d-md-flex">
                  <form action="#" id="leadSearchForm">
                    <input
                      type="text"
                      id="leadSearchInput"
                      placeholder="Search by Lead Name..."
                    />
                    <button type="button" onclick="searchLeads()">
                      <i class="lni lni-search-alt"></i>
                    </button>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right"></div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section class="section">
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center">
              <div class="col-md-6">
                <div class="title">
                  <h2>Lead List</h2>
                </div>
              </div>
              <!-- end col -->
            </div>
            <!-- end row -->
          </div>

          <a
            href="closeleads.html"
            class="main-btn danger-btn square-btn btn-hover"
          >
            Close Leads
          </a>

          <div class="row">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <h6 class="mb-10">Data Table</h6>
                <div class="table-wrapper table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>
                          <h6>Name</h6>
                        </th>
                        <th>
                          <h6>Mobile No</h6>
                        </th>
                        <th>
                          <h6>Email</h6>
                        </th>
                        <th>
                          <h6>Course</h6>
                        </th>
                        <th>
                          <h6>Status</h6>
                        </th>
                        <th>
                          <h6>Action</h6>
                        </th>
                        <th>
                          <h6>Details</h6>
                        </th>
                      </tr>
                      <!-- end table row-->
                    </thead>

                    <tbody id="leadData">
                      <!-- Lead data will be dynamically added here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- ========== section end ========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->

    <!-- ========= All Javascript files linkup ======== -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/Chart.min.js"></script>
    <script src="assets/js/dynamic-pie-chart.js"></script>
    <script src="assets/js/moment.min.js"></script>
    <script src="assets/js/fullcalendar.js"></script>
    <script src="assets/js/jvectormap.min.js"></script>
    <script src="assets/js/world-merc.js"></script>
    <script src="assets/js/polyfill.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/jquery.js"></script>
    <!-- <script src="assets/js/user.js"></script> -->
    <script>
      function fetchLeadData() {
        fetch("http://localhost:8080/get-lead-data")
          .then((response) => response.json())
          .then((data) => {
            const leadData = document.getElementById("leadData");
            // Clear existing data
            //leadData.innerHTML = "";

            data
              .filter(
                (lead) => lead.status === "Active" || lead.status === "Pending"
              )
              .forEach((lead) => {
                const row = document.createElement("tr");
                // Set the lead id as a data attribute
                row.dataset.leadId = lead.id; // Assuming lead has a property called 'id'

                row.innerHTML = `
                      <td>${lead.name}</td>
                      <td>${lead.mobile}</td>
                      <td>${lead.email}</td>
                      <td>${lead.courseIntrested}</td>
                      <td>${lead.status}</td>
                      <td>
                          <div class="action">
                              ${
                                lead.status === "Pending"
                                  ? `
                                      <select onchange="changeStatus(this)">
                                          <option value="">Edit</option>
                                          <option value="Active">Active</option>
                                          <option value="Done">Done</option>
                                          <option value="Close">Close</option>
                                      </select>
                                  `
                                  : lead.status === "Active"
                                  ? `
                                      <select onchange="changeStatus(this)">
                                          <option value="">Edit</option>
                                          <option value="Pending">Pending</option>
                                          <option value="Done">Done</option>
                                          <option value="Close">Close</option>
                                      </select>
                                  `
                                  : lead.status === "Done"
                                  ? `
                                      <a href="invoice.html?leadName=${lead.name}&leadEmail=${lead.email}" class="create-invoice-link">
                                          Invoice
                                      </a>
                                  `
                                  : lead.status === "Close"
                                  ? `
                                      <a style="color: red;">Delete</a>
                                  `
                                  : ""
                              }
                          </div>
                      </td>
                      
                      <td class="dropdown-ll" onclick="handleDropdownClick('${
                        lead.id
                      }')">&#9660;</td>
                  `;
                leadData.appendChild(row);
              });
          })
          .catch((error) => {
            console.error("Error fetching data: " + error);
          });
      }

      function getButtonClass(status) {
        switch (status) {
          case "Active":
            return "newbtnact";
          case "Done":
            return "newbtndone";
          case "Close":
            return "newbtnclose";
          case "Pending":
            return "newbtnpending";
          default:
            return "default-btn"; // You can define a default class for other statuses
        }
      }

      function showConfirmationDialog(selectedStatus, row) {
        const currentStatus = row.querySelector("td:nth-child(5)").textContent;
        return confirm(
          `Do you want to change status from ${currentStatus} to ${selectedStatus}?`
        );
      }

      function changeStatus(selectElement) {
        const selectedStatus = selectElement.value;
        const row = selectElement.closest("tr");
        const leadId = row.dataset.leadId;

        if (!showConfirmationDialog(selectedStatus, row)) {
          // User clicked Cancel in the confirmation dialog
          selectElement.value =
            row.querySelector("td:nth-child(5)").textContent;
          return;
        }

        fetch(`http://localhost:8080/update-lead/${leadId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: selectedStatus }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((updatedStatus) => {
            const statusCell = row.querySelector("td:nth-child(5)");
            const actionCell = row.querySelector("td:nth-child(6)");

            statusCell.textContent = updatedStatus;
            statusCell.className = getButtonClass(updatedStatus);
            actionCell.innerHTML = getActionHTML(
              updatedStatus,
              row.cells[0].textContent,
              row.cells[2].textContent
            );

            if (updatedStatus === "Done") {
              if (confirm("Do you want to change status as Done?")) {
                statusCell.textContent = updatedStatus;
                statusCell.className = getButtonClass(updatedStatus);
                actionCell.innerHTML = getActionHTML(
                  updatedStatus,
                  row.cells[0].textContent,
                  row.cells[2].textContent
                );
              } else {
                // Revert to the previous status
                selectElement.value = statusCell.textContent;
              }
            } else {
              statusCell.textContent = updatedStatus;
              statusCell.className = getButtonClass(updatedStatus);
              actionCell.innerHTML = getActionHTML(updatedStatus);
            }

            // Reload the page after updating the status
            window.location.reload();
          })
          .catch((error) => {
            console.error("Error updating status: " + error);
          });
      }

      function getActionHTML(status, name, email) {
        // Remove double quotes from status if present
        // status = status.replaceAll('"', "");

        if (status === "Done") {
          return `
            <a href="invoice.html?leadName=${name}&leadEmail=${email}" class="create-invoice-link">
                Invoice
            </a>
        `;
        } else if (status === "Close") {
          return `
            <a style="color: red;">Delete</a>
        `;
        } else if (status === "Active") {
          return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Active" ? "selected" : ""
                }>Edit</option>
                <option value="Pending" ${
                  status === "Pending" ? "selected" : ""
                }>Pending</option>
                <option value="Done" ${
                  status === "Done" ? "selected" : ""
                }>Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
        } else if (status === "Pending") {
          return `
          <select onchange="changeStatus(this)">
                <option value="" ${
                  status === "Pending" ? "selected" : ""
                }>Edit</option>
                <option value="Active" ${
                  status === "Active" ? "selected" : ""
                }>Active</option>
                <option value="Done" ${
                  status === "Done" ? "selected" : ""
                }>Done</option>
                <option value="Close" ${
                  status === "Close" ? "selected" : ""
                }>Close</option>
            </select>
          `;
        } else {
          return "";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchLeadData();
        document.addEventListener("change", function (event) {
          if (event.target.tagName === "SELECT") {
            changeStatus(event.target);
          }
        });
      });
    </script>
    <script>
      function searchLeads() {
        var searchTerm = document
          .getElementById("leadSearchInput")
          .value.toLowerCase();
        var leadRows = document.querySelectorAll("#leadData tr");

        leadRows.forEach(function (leadRow) {
          var leadNameText = leadRow
            .querySelector("td:nth-child(1)")
            .textContent.toLowerCase();

          if (leadNameText.includes(searchTerm)) {
            leadRow.style.display = "table-row";
          } else {
            leadRow.style.display = "none";
          }
        });
      }
    </script>
    <script>
      function createDropdownTable(parentElement, leadId) {
        // Check if the dropdown table already exists
        const existingDropdownTable = parentElement.querySelector("table");

        if (existingDropdownTable) {
          // If the table exists, remove it to recreate it
          parentElement.removeChild(existingDropdownTable);
        }

        // Create a new table
        const dropdownTable = document.createElement("table");
        dropdownTable.style.border = "1px solid #ccc";
        dropdownTable.style.backgroundColor = "#fff";

        // Create table header (thead)
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const headerName = document.createElement("th");
        const headerStatus = document.createElement("th");

        headerName.textContent = "Name";
        headerStatus.textContent = "Status";

        headerRow.appendChild(headerName);
        headerRow.appendChild(headerStatus);
        thead.appendChild(headerRow);
        dropdownTable.appendChild(thead);

        // Create table body (tbody) with sample data
        const tbody = document.createElement("tbody");

        const rowData1 = document.createElement("tr");
        const cell1 = document.createElement("td");
        const cell2 = document.createElement("td");

        cell1.textContent = "DB2";
        cell2.textContent = "Active";

        rowData1.appendChild(cell1);
        rowData1.appendChild(cell2);
        tbody.appendChild(rowData1);

        const rowData2 = document.createElement("tr");
        const cell3 = document.createElement("td");
        const cell4 = document.createElement("td");

        cell3.textContent = "DB2 Parsing";
        cell4.textContent = "Active";

        rowData2.appendChild(cell3);
        rowData2.appendChild(cell4);
        tbody.appendChild(rowData2);

        dropdownTable.appendChild(tbody);

        // Append the new table to the parent element
        parentElement.appendChild(dropdownTable);
      }

      function handleDropdownClick(leadId) {
        const dropdownContainer = document.getElementById(
          `dropdownContainer_${leadId}`
        );

        // Check if dropdownContainer exists
        if (!dropdownContainer) {
          console.error(`Dropdown container not found for lead ID: ${leadId}`);
          return;
        }

        console.log(`Dropdown clicked for lead ID: ${leadId}`);
        createDropdownTable(dropdownContainer, leadId);
      }

      document.addEventListener("DOMContentLoaded", function () {
        fetchLeadData();
        document.addEventListener("change", function (event) {
          if (event.target.tagName === "SELECT") {
            changeStatus(event.target);
          }
        });

        // Add event listener to document body for handling clicks
        document.body.addEventListener("click", function (event) {
          // Check if the clicked element has a 'data-lead-id' attribute
          const leadId = event.target.getAttribute("data-lead-id");

          if (leadId) {
            handleDropdownClick(leadId);
          }
        });
      });
    </script>
  </body>
</html>
