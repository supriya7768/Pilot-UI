<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="assets/images/favicon.svg"
      type="image/x-icon"
    />
    <title>Shepherd</title>

    <!-- ========== All CSS files linkup ========= -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="assets/css/lineicons.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="assets/css/materialdesignicons.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="assets/css/fullcalendar.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js"></script>
  </head>

  <body>
    <!-- ======== Preloader =========== -->
    <div id="preloader">
      <div class="spinner"></div>
    </div>
    <!-- ======== Preloader =========== -->

    <!-- ======== sidebar-nav start =========== -->
    <aside class="sidebar-nav-wrapper">
      <div class="navbar-logo">
        <a href="index.html">
          <img
            style="height: 150px; width: 150px"
            src="./assets/images/SHEPHERD 2.jpg"
          />
        </a>
      </div>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="index.html">
              <span class="icon">
                <img class="hi" src="./assets/images/dashboard.png" alt="" />
              </span>
              <span class="text">Dashboard</span>
            </a>
          </li>
        </ul>
      </nav>

      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="addlead.html">
              <span class="icon">
                <img class="hi" src="./assets/images/user.png" alt="" />
              </span>
              <span class="text">Add Lead</span>
            </a>
          </li>
        </ul>
      </nav>

      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="leadlist.html">
              <span class="icon">
                <img class="hi" src="./assets/images/group.png" alt="" />
              </span>
              <span class="text">Lead List</span>
            </a>
          </li>
        </ul>
      </nav>

      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="invoice.html">
              <span class="icon">
                <img class="hi" src="./assets/images/invoice.png" alt="" />
              </span>

              <span class="text">Invoice</span>
            </a>
          </li>
        </ul>
      </nav>
      <nav class="sidebar-nav">
        <ul>
          <li class="nav-item">
            <a href="studentpanel.html">
              <span class="icon">
                <img class="hi" src="./assets/images/students.png" alt="" />
              </span>
              <span class="text">Subscribers</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <div class="overlay"></div>
    <!-- ======== sidebar-nav end =========== -->

    <!-- ======== main-wrapper start =========== -->
    <main class="main-wrapper">
      <!-- ========== header start ========== -->
      <header class="header">
        <div class="container-fluid">
          <div class="row">
            <div class="col-lg-5 col-md-5 col-6">
              <div class="header-left d-flex align-items-center">
                <div class="menu-toggle-btn mr-15">
                  <button
                    id="menu-toggle"
                    class="main-btn primary-btn btn-hover"
                  >
                    <i class="lni lni-chevron-left me-2"></i> Menu
                  </button>
                </div>
              </div>
            </div>
            <div class="col-lg-7 col-md-7 col-6">
              <div class="header-right">
                <!-- profile start -->
                <div class="profile-box ml-15">
                  <button
                    class="dropdown-toggle bg-transparent border-0"
                    type="button"
                    id="profile"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                  >
                    <div class="profile-info">
                      <div class="info">
                        <div class="image">
                          <img src="assets/images/logo.png" alt="" />
                        </div>
                        <div>
                          <h6 class="fw-500">Testing Shastra</h6>
                          <p>Admin</p>
                        </div>
                      </div>
                    </div>
                  </button>
                  <ul
                    class="dropdown-menu dropdown-menu-end"
                    aria-labelledby="profile"
                  >
                    <li>
                      <div class="author-info flex items-center !p-1">
                        <div class="image">
                          <img
                            src="assets/images/profile/profile-image.png"
                            alt="image"
                          />
                        </div>
                        <div class="content">
                          <h4 class="text-sm">Adam Joe</h4>
                          <a
                            class="text-black/40 dark:text-white/40 hover:text-black dark:hover:text-white text-xs"
                            href="#"
                            >Email@gmail.com</a
                          >
                        </div>
                      </div>
                    </li>
                    <li class="divider"></li>
                    <li>
                      <a href="#0">
                        <i class="lni lni-user"></i> View Profile
                      </a>
                    </li>
                    <li>
                      <a href="#0">
                        <i class="lni lni-alarm"></i> Notifications
                      </a>
                    </li>
                    <li>
                      <a href="#0"> <i class="lni lni-inbox"></i> Messages </a>
                    </li>
                    <li>
                      <a href="#0"> <i class="lni lni-cog"></i> Settings </a>
                    </li>
                    <li class="divider"></li>
                    <li>
                      <a href="#0"> <i class="lni lni-exit"></i> Sign Out </a>
                    </li>
                  </ul>
                </div>
                <!-- profile end -->
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- ========== header end ========== -->

      <!-- ========== section start ========== -->
      <section>
        <div class="container-fluid">
          <!-- ========== title-wrapper start ========== -->
          <div class="title-wrapper pt-30">
            <div class="row align-items-center"></div>
            <!-- end row -->
          </div>
          <!-- ========== title-wrapper end ========== -->

          <!-- Invoice Wrapper Start -->
          <form id="myprint">
            <div class="invoice-wrapper">
              <div class="row">
                <div class="col-12">
                  <div class="invoice-card card-style mb-30">
                    <div class="invoice-header">
                      <div class="invoice-for">
                        <span
                          ><img
                            style="padding-left: 30px; width: 55px"
                            src="./assets/images/logo.png"
                            alt="" /></span
                        ><br />
                        <span style="padding-top: 5px">
                          <h2 class="mb-10">Invoice</h2>
                        </span>
                      </div>
                      <div class="invoice-date">
                        <p>
                          <span>Invoice ID:</span
                          ><input
                            style="width: 35%; border: none"
                            type="text"
                            id="invoiceId"
                            readonly
                          />
                        </p>
                        <span>Date:</span
                        ><span style="padding-left: 25px">
                          <p id="myId"></p>
                        </span>
                      </div>
                    </div>
                    <div class="invoice-address">
                      <div class="address-item">
                        <h5 class="text-bold">Bill from</h5>
                        <h1>Testing Shastra</h1>
                        <p class="text-sm">
                          504, Ganeesham E, Pimple Saudagar, Pune
                        </p>
                        <p class="text-sm">
                          <span class="text-medium">Email:</span>
                          info@testingshastra.com
                        </p>
                      </div>
                      <div class="address-item">
                        <h5 class="text-bold">Bill to</h5>
                        <h1 id="leadName"></h1>
                        <p class="text-sm">
                          <span class="text-medium">Email:</span>
                          <span id="leadEmail"></span>
                        </p>
                        <p class="text-sm">
                          <span class="text-medium">Mobile No:</span>
                          <span id="leadMobile"></span>
                        </p>
                      </div>
                    </div>
                    <div class="table-responsive">
                      <table id="invoiceTable">
                        <thead>
                          <tr>
                            <th class="service">
                              <h6 class="text-sm text-medium">Sr.No</h6>
                            </th>
                            <th class="desc">
                              <h6
                                style="padding-left: 25%"
                                class="text-sm text-medium"
                              >
                                Course
                              </h6>
                            </th>
                            <th class="rate">
                              <h6 class="text-sm text-medium">Rate</h6>
                            </th>
                            <th class="gst">
                              <h6 class="text-sm text-medium">GST</h6>
                            </th>
                            <th class="gst">
                              <h6 class="text-sm text-medium">GST Value</h6>
                            </th>
                            <th class="amount">
                              <h6 class="text-sm text-medium">Subtotal</h6>
                            </th>
                            <!-- <th class="text-sm">Action</th> -->
                          </tr>
                        </thead>
                        <tbody>
                          <!-- Initial row for demonstration -->
                          <tr>
                            <td>1</td>
                            <td>
                              <div class="select-style-1">
                                <!-- <label>Category</label> -->
                                <div class="select-position">
                                  <select id="course" class="course">
                                    <option value="">Select category</option>
                                    <option>
                                      Software Testing(Java Selenium)
                                    </option>
                                    <option>
                                      Automation Testing(Python Selenium)
                                    </option>
                                    <option>Rest API Testing</option>
                                    <option>Java Full Stack Development</option>
                                    <option>
                                      MERN Java Full Stack Development
                                    </option>
                                    <option>.NET Full Stack Development</option>
                                    <option>Diploma in UI/UX Design</option>
                                  </select>
                                </div>
                              </div>
                            </td>
                            <td>
                              <div class="input-style-1">
                                <input
                                  type="number"
                                  id="rateOfCourse"
                                  placeholder="Rate of Course"
                                />
                              </div>
                            </td>
                            <td>
                              <div class="input-style-1">
                                <input type="number" placeholder="%" />
                              </div>
                            </td>
                            <td>
                              <div class="input-style-1">
                                <input
                                  type="number"
                                  placeholder="GST value"
                                  readonly
                                />
                              </div>
                            </td>
                            <td>
                              <div class="input-style-1">
                                <input
                                  type="number"
                                  id="subtotal"
                                  placeholder="Subtotal"
                                  readonly
                                />
                              </div>
                            </td>
                            <!-- <td>
                            <button class="deleteRow delbtn main-btn btn-hover">
                              Delete
                            </button>
                          </td> -->
                          </tr>
                        </tbody>
                      </table>

                      <button
                        style="margin-left: 40px"
                        class="primary-btn primary-btn-light closebtn main-btn btn-hover"
                        id="addRow"
                      >
                        Add
                      </button>
                      <!-- <button id="savePDF">Save as PDF</button> -->
                    </div>

                    <div class="invoice-action">
                      <div class="input-style-1">
                        <label>Paid Amount</label>
                        <input
                          type="number"
                          id="paidAmount"
                          placeholder="Paid Amount"
                        />
                        <label>Due Amount</label>
                        <input
                          type="number"
                          id="dueAmount"
                          placeholder="Pending Amount"
                          readonly
                        />
                        <label>Due Date</label>
                        <input type="date" id="dueDate" />
                        <label>Total</label>
                        <input
                          type="number"
                          id="totalAmount"
                          placeholder="Total Amount"
                          readonly
                        />
                      </div>
                    </div>

                    <div class="invoice-action">
                      <ul
                        class="d-flex flex-wrap align-items-center justify-content-center"
                      >
                        <li class="m-2">
                          <a
                            target="_blank"
                            href="./invoice-print.html"
                            onclick="addInvoice()"
                            class="main-btn primary-btn-outline btn-hover"
                            style="height: 30px; width: 30px"
                          >
                            Save
                          </a>
                        </li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
          <!-- Invoice Wrapper End -->
          <div class="h-20">
            <h1 id="dt"></h1>
          </div>
          <div class="invoice-action">
            <ul
              class="d-flex flex-wrap align-items-center justify-content-center"
            >
              <li class="m-2">
                <a
                  href="#0"
                  class="main-btn primary-btn-outline btn-hover"
                  id="downloadPdfButton"
                >
                  Download pdf
                </a>
              </li>
              <li class="m-2">
                <a href="#0" class="main-btn primary-btn-outline btn-hover">
                  Send via whatsapp
                </a>
              </li>
              <li class="m-2">
                <a href="#0" class="main-btn primary-btn-outline btn-hover">
                  Send via email
                </a>
              </li>
              <!-- <li class="m-2">
                <a href="#0" class="main-btn primary-btn btn-hover">
                  Send Invoice
                </a>
              </li> -->
            </ul>
          </div>
        </div>

        <!-- end container -->
      </section>
      <!-- ========== section end ========== -->
    </main>
    <!-- ======== main-wrapper end =========== -->

    <!-- ========= All Javascript files linkup ======== -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="assets/js/Chart.min.js"></script> -->
    <!-- <script src="assets/js/dynamic-pie-chart.js"></script> -->
    <script src="assets/js/moment.min.js"></script>
    <script src="assets/js/fullcalendar.js"></script>
    <script src="assets/js/jvectormap.min.js"></script>
    <script src="assets/js/world-merc.js"></script>
    <script src="assets/js/polyfill.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/invoice.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.js"></script>
    <!-- Add this script to the end of your HTML body -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Fetch the last used Invoice ID from storage (localStorage)
        $.ajax({
          type: "GET",
          url: "http://localhost:8080/last-invoice-id",
          success: function (lastUsedInvoiceId) {
            // Check if there's a last used Invoice ID from the server
            if (lastUsedInvoiceId) {
              // If there is, use it as the starting point for the next Invoice ID
              $("#invoiceId").val(parseInt(lastUsedInvoiceId) + 1);
            } else {
              // If there is no last used Invoice ID, set a default starting point
              $("#invoiceId").val(231201); // You can adjust this value as needed
            }
          },
          error: function (error) {
            console.error("Error fetching last used Invoice ID:", error);
          },
        });

        var date = new Date();
        var dd = date.getDate();
        var mm = date.getMonth() + 1;
        var yyyy = date.getFullYear();
        var newDate = dd + "-" + mm + "-" + yyyy;
        var p = document.getElementById("myId");
        p.innerHTML = newDate;

        // Extract the lead's name from the URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const leadName = urlParams.get("leadName");
        const leadEmail = urlParams.get("leadEmail");
        const leadMobile = urlParams.get("leadMobile");

        // Update the <h1> tag with the lead's name
        if (leadName) {
          document.getElementById("leadName").textContent = leadName;
        }
        if (leadEmail) {
          document.getElementById("leadEmail").textContent = leadEmail;
        }
        if (leadMobile) {
          document.getElementById("leadMobile").textContent = leadMobile;
        }

        // Handle click event on "Download pdf" button
        document
          .getElementById("downloadPdfButton")
          .addEventListener("click", function () {
            // Target the element containing the content you want to convert to PDF
            const element = document.querySelector(".invoice-wrapper");

            // Configure the PDF options
            const pdfOptions = {
              margin: [10, 10, 10, 10], // Set margins (top, right, bottom, left)
              filename: "invoice.pdf",
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 5 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
              yOffset: -20, // Set a negative yOffset to move content up (adjust this value as needed)
            };

            // Generate the PDF
            html2pdf(element, pdfOptions);
          });
        updateTotal();
      });
    </script>

    <script>
      $(document).ready(function () {
        $("#paidAmount").on("input", function () {
          var paidAmount = parseFloat($(this).val()) || 0;
          var totalAmount = parseFloat($("#totalAmount").val()) || 0;
          var dueAmount = totalAmount - paidAmount;
          $("#dueAmount").val(dueAmount.toFixed(2));
        });
      });
    </script>

    <script>
      $(document).ready(function () {
        // Add Row button functionality
        $("#addRow").on("click", function () {
          var newRow = $("<tr>");
          newRow.append(
            "<td>" + ($("#invoiceTable tbody tr").length + 1) + "</td>"
          );
          newRow.append(`
            <td>
              <div class="select-style-1">
                              <div class="select-position">
                                <select id="course" class="course">
                                  <option value="">Select category</option>
                            <option value="Software Testing(Java Selenium)">Software Testing(Java Selenium)</option>
                            <option>
                              Automation Testing(Python Selenium)
                            </option>
                            <option>Rest API Testing</option>
                            <option>Java Full Stack Development</option>
                            <option>MERN Java Full Stack Development</option>
                            <option>.NET Full Stack Development</option>
                            <option>Diploma in UI/UX Design</option>
                                </select>
                              </div>
            </td>
        `);
          newRow.append(`"<td><div class="input-style-1">
                              <input type="number" placeholder="Rate of Course" />
                            </div></td>"`);
          newRow.append(
            `"<td> <div class="input-style-1">
                            <input type="number" placeholder="%" />
                          </div></td>"`
          );
          newRow.append(
            `"<td> <div class="input-style-1">
                            <input type="number" placeholder="GST value" readonly/> 
                          </div></td>"`
          );
          newRow.append(
            `"<td> <div class="input-style-1">
                            <input type="number" placeholder="Subtotal" readonly/>
                          </div></td>"`
          );
          newRow.append(
            "<td><button class='deleteRow delbtn main-btn btn-hover'>Delete</button></td>"
          );

          newRow
            .find(".input-style-1 input[placeholder='Rate of Course']")
            .on("input", function () {
              calculateRowValues(newRow);
            });

          newRow
            .find(".input-style-1 input[placeholder='%']")
            .on("input", function () {
              calculateRowValues(newRow);
            });

          // Append the new row to the table body
          $("#invoiceTable tbody").append(newRow);
        });

        // Input event listeners for rate and percentage calculation
        $("#invoiceTable tbody").on(
          "input",
          ".input-style-1 input[placeholder='Rate of Course'], .input-style-1 input[placeholder='%']",
          function () {
            var row = $(this).closest("tr");
            calculateRowValues(row);
          }
        );

        // Delete Row button functionality
        $(document).on("click", ".deleteRow", function () {
          // $(this).closest("tr").remove();
          var row = $(this).closest("tr");

          // Remove the row from the database
          removeRowFromDatabase(row);

          // Remove the row from the table
          row.remove();

          // Update row numbers in the first column
          $("#invoiceTable tbody tr").each(function (index) {
            $(this)
              .find("td:first")
              .text(index + 1);
          });

          updateTotal();
        });
      });

      function removeRowFromDatabase(row) {
        // Extract the subtotal from the row being removed
        var subtotal =
          parseFloat(
            row.find(".input-style-1 input[placeholder='Subtotal']").val()
          ) || 0;

        var currentTotal = parseFloat($("#totalAmount").val()) || 0;
        var newTotal = currentTotal - subtotal;

        $("#totalAmount").val(newTotal.toFixed(2));
        console.log("Row removed from the database. Subtotal:", subtotal);
        console.log("Total amount updated. New total:", newTotal);
      }
    </script>

    //
    <script>
      function updateTotal() {
        console.log("updateTotal called");
        var total = 0;
        $("#invoiceTable tbody tr").each(function () {
          var subtotalInput = $(this).find(
            ".input-style-1 input[placeholder='Subtotal']"
          );
          var subtotal = parseFloat(subtotalInput.val()) || 0;

          console.log("Subtotal for row:", subtotal);
          total += subtotal;
        });

        console.log("Total:", total);

        $("#totalAmount").val(total.toFixed(2));

        $("input[placeholder='Paid Amount']").trigger("input");
      }

      $("#invoiceTable tbody").on(
        "input",
        ".input-style-1 input[placeholder='Subtotal']",
        function () {
          updateTotal();
        }
      );

      function calculateRowValues(row) {
        var rateInput = row.find(
          ".input-style-1 input[placeholder='Rate of Course']"
        );
        var percentageInput = row.find(".input-style-1 input[placeholder='%']");
        var gstValueInput = row.find(
          ".input-style-1 input[placeholder='GST value']"
        );
        var subtotalInput = row.find(
          ".input-style-1 input[placeholder='Subtotal']"
        );

        var rate = parseFloat(rateInput.val()) || 0;
        var percentage = parseFloat(percentageInput.val()) || 0;

        var gstValue = (rate * percentage) / 100;
        var subtotal = rate + gstValue;

        console.log("Rate:", rate);
        console.log("Percentage:", percentage);
        console.log("GST Value:", gstValue);
        console.log("Subtotal:", subtotal);

        gstValueInput.val(gstValue.toFixed(2));
        subtotalInput.val(subtotal.toFixed(2));

        subtotalInput.trigger("input");
      }

      $("#invoiceTable tbody").on(
        "input",
        ".input-style-1 input[placeholder='Subtotal']",
        function () {
          updateTotal();
        }
      );
    </script>

    <script>
      function addInvoice() {
        var invoiceData = {
          invoiceId: parseInt($("#invoiceId").val()),
          name: $("#leadName").text(),
          email: $("#leadEmail").text(),
          mobile: $("#leadMobile").text(),
          course: $("#course").val(), // Use .val() to get the selected option's value
          rate: parseFloat($("#rateOfCourse").val()),
          subtotal: parseFloat($("#subtotal").val()),
          paidAmount: parseFloat($("#paidAmount").val()),
          dueDate: $("#dueDate").val(),
          dueAmount: parseFloat($("#dueAmount").val()),
          total: parseFloat($("#totalAmount").val()),
        };

        $.ajax({
          type: "POST",
          url: "http://localhost:8080/add-invoice", // Replace with your actual backend endpoint
          contentType: "application/json",
          data: JSON.stringify(invoiceData),
          success: function (response) {
            console.log("Invoice added successfully:", response);
            $("#dt").text(response);
          },
          error: function (error) {
            console.error("Error adding invoice:", error);
          },
        });
      }
    </script>
  </body>
</html>
